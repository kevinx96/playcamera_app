camera.dart:
class Camera {
  final int id;
  final String name;
  final String status;

  Camera({
    required this.id,
    required this.name,
    required this.status,
  });

  // fromJson æ„é€ å‡½æ•°ï¼Œç”¨äºå°† API è¿”å›çš„ JSON (Map) è½¬æ¢ä¸º Camera å¯¹è±¡
  factory Camera.fromJson(Map<String, dynamic> json) {
    return Camera(
      id: json['id'] as int,
      name: json['name'] as String,
      // [FIX] ç¡®ä¿ status å­—æ®µè¢«è§£æï¼Œå¹¶æä¾›ä¸€ä¸ªé»˜è®¤å€¼
      status: json['status'] as String? ?? 'offline', 
    );
  }
}

report_case.dart:
import 'package:intl/intl.dart'; // [NEW] å¯¼å…¥ intl åŒ…

class ReportCase {
  final int id;
  final int cameraId;
  final String equipmentType; // [MODIFIED] ä» category æ”¹ä¸º equipmentType
  final int score;
  final String thumbnailUrl;
  final String status;
  final DateTime eventTime; // [MODIFIED] ä» timestamp æ”¹ä¸º eventTime

  ReportCase({
    required this.id,
    required this.cameraId,
    required this.equipmentType, // [MODIFIED]
    required this.score,
    required this.thumbnailUrl,
    required this.status,
    required this.eventTime, // [MODIFIED]
  });

  factory ReportCase.fromJson(Map<String, dynamic> json) {
    String dateString = json['event_time'] as String? ?? '';
    DateTime parsedDate;

    try {
      // [FIXED] å°è¯•è§£æ RFC 1123 æ ¼å¼ (e.g., "Mon, 27 Oct 2025 22:48:30 GMT")
      // æ³¨æ„ï¼šHttpDate.parse() æ›´å¥å£®ï¼Œä½†éœ€è¦ dart:io å¯¼å…¥ï¼Œæ¨¡å‹ä¸­ä¸æ¨è
      // æˆ‘ä»¬ä½¿ç”¨ intl çš„ DateFormat
      parsedDate = DateFormat("E, dd MMM yyyy HH:mm:ss 'GMT'").parseUtc(dateString);
    } catch (e) {
      try {
        // å¦‚æœ RFC 1123 å¤±è´¥ï¼Œå°è¯•è§£æ ISO 8601 (å¤‡ç”¨æ–¹æ¡ˆ)
        parsedDate = DateTime.parse(dateString);
      } catch (e2) {
        // å¦‚æœéƒ½å¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´æˆ–ä¸€ä¸ªé»˜è®¤æ—¶é—´
        print("âš ï¸ Failed to parse date: $dateString. Error: $e and $e2");
        parsedDate = DateTime.now(); // æˆ–è€… DateTime(1970)
      }
    }

    return ReportCase(
      id: json['id'] as int,
      cameraId: json['camera_id'] as int? ?? 0,
      equipmentType: json['equipment_type'] as String? ?? 'ä¸æ˜', // [MODIFIED]
      score: json['score'] as int? ?? 0,
      thumbnailUrl: json['thumbnail_url'] as String? ?? '', // [MODIFIED] ä½¿ç”¨åç«¯åˆ«å
      status: json['status'] as String? ?? 'ä¸æ˜',
      eventTime: parsedDate, // [MODIFIED] ä½¿ç”¨è§£æåçš„æ—¥æœŸ
    );
  }
}
report_detail.dart:
import 'package:flutter/foundation.dart';

// å¯¹åº” GET /api/events/{id} è¿”å›çš„ data å¯¹è±¡
class ReportDetail {
  final int id;
  final int cameraId;
  final String category;
  final int score;
  final DateTime timestamp;
  final int imageCount;
  final List<ImageDetail> images;

  ReportDetail({
    required this.id,
    required this.cameraId,
    required this.category,
    required this.score,
    required this.timestamp,
    required this.imageCount,
    required this.images,
  });

  // [FIX] æ·»åŠ  fromJson å·¥å‚æ„é€ å‡½æ•°
  factory ReportDetail.fromJson(Map<String, dynamic> json) {
    var imagesList = json['images'] as List? ?? [];
    List<ImageDetail> parsedImages = imagesList
        .map((i) => ImageDetail.fromJson(i as Map<String, dynamic>))
        .toList();

    return ReportDetail(
      id: json['id'] as int,
      cameraId: json['camera_id'] as int? ?? 0,
      category: json['category'] as String? ?? 'ä¸æ˜',
      score: json['score'] as int? ?? 0,
      timestamp: DateTime.parse(json['timestamp'] as String? ?? ''),
      imageCount: json['image_count'] as int? ?? 0,
      images: parsedImages,
    );
  }
}

// å¯¹åº” ReportDetail.images åˆ—è¡¨ä¸­çš„å•ä¸ªå›¾ç‰‡å¯¹è±¡
class ImageDetail {
  final int imageId;
  final String imageUrl;
  final DateTime timestamp;
  final int score;
  final List<String> deductionItems;

  ImageDetail({
    required this.imageId,
    required this.imageUrl,
    required this.timestamp,
    required this.score,
    required this.deductionItems,
  });

  // [FIX] æ·»åŠ  fromJson å·¥å‚æ„é€ å‡½æ•°
  factory ImageDetail.fromJson(Map<String, dynamic> json) {
    var deductionsList = json['deduction_items'] as List? ?? [];
    List<String> parsedDeductions =
        deductionsList.map((item) => item.toString()).toList();

    return ImageDetail(
      imageId: json['image_id'] as int,
      imageUrl: json['image_url'] as String? ?? '',
      timestamp: DateTime.parse(json['timestamp'] as String? ?? ''),
      score: json['score'] as int? ?? 0,
      deductionItems: parsedDeductions,
    );
  }
}

user.dart:
class User {
  final int id;
  final String username;
  final String email;
  final String fullName;
  final String role;
  // final DateTime createdAt; // æ‚¨çš„ API JSON ä¸­ä¸åŒ…å«æ­¤é¡¹ï¼Œæš‚æ—¶æ³¨é‡Š

  User({
    required this.id,
    required this.username,
    required this.email,
    required this.fullName,
    required this.role,
    // required this.createdAt,
  });

  // Factory constructor to parse JSON
  factory User.fromJson(Map<String, dynamic> json) {
    return User(
      // æˆ‘ä»¬çš„ API è¿”å› 'user_id'ï¼Œä½†Dartä¹ æƒ¯ç”¨'id'
      id: json['user_id'] ?? json['id'], 
      username: json['username'],
      email: json['email'],
      fullName: json['full_name'],
      role: json['role'],
      // createdAt: DateTime.parse(json['created_at']),
    );
  }
}

auth_provider.dart:
import 'package:flutter/material.dart';
import 'dart:developer' as developer; // [NEW] å¯¼å…¥ developer åº“ç”¨äºæ›´è¯¦ç»†çš„æ—¥å¿—
import '../models/user.dart';
import '../services/api_service.dart';

class AuthProvider with ChangeNotifier {
  User? _user;
  String? _token;
  bool _isLoading = false;
  String? _error;

  User? get user => _user;
  String? get token => _token;
  bool get isLoading => _isLoading;
  String? get error => _error;
  bool get isAuthenticated => _token != null;

  // [REMOVED] ApiService å®ä¾‹å°†ç”± ProxyProvider æ³¨å…¥
  // final ApiService _apiService = ApiService(null);

  Future<bool> login(String username, String password) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    // ç™»å½•æ—¶ä¸´æ—¶åˆ›å»ºä¸€ä¸ª ApiService å®ä¾‹ (ä¸éœ€è¦ token)
    final tempApiService = ApiService(null);

    try {
      developer.log('Attempting login for user: $username', name: 'AuthProvider.login'); // [NEW LOG]
      final response = await tempApiService.login(username, password);
      developer.log('Login API response received: $response', name: 'AuthProvider.login'); // [NEW LOG]

      _token = response['token'];
      _user = User.fromJson(response['user']);

      // [REMOVED] ä¸å†éœ€è¦ setToken
      // _apiService.setToken(_token!);

      _isLoading = false;
      developer.log('Login successful. Token set. Notifying listeners.', name: 'AuthProvider.login'); // [NEW LOG]
      notifyListeners(); // æ­¤æ—¶ _token å·²ç»æ›´æ–°ï¼ŒProxyProvider ä¼šæ£€æµ‹åˆ°
      return true;

    } catch (e, stackTrace) { // [MODIFIED] æ•è·å †æ ˆè·Ÿè¸ª
      // [MODIFIED] æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
      _error = "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.toString()}";
      _isLoading = false;
      // **** è¿™é‡Œæ·»åŠ äº†æ›´è¯¦ç»†çš„æ—¥å¿— ****
      developer.log(
        'Login failed!', 
        name: 'AuthProvider.login', 
        error: e, 
        stackTrace: stackTrace
      ); 
      notifyListeners();
      return false;
    }
  }

  Future<bool> register({
    required String username,
    required String password,
    required String email,
    required String fullName,
  }) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    // æ³¨å†Œæ—¶ä¸´æ—¶åˆ›å»ºä¸€ä¸ª ApiService å®ä¾‹ (ä¸éœ€è¦ token)
    final tempApiService = ApiService(null);

    try {
      developer.log('Attempting registration for user: $username', name: 'AuthProvider.register'); // [NEW LOG]
      final response = await tempApiService.register(
        username: username,
        password: password,
        email: email,
        fullName: fullName,
      );
      developer.log('Register API response received: $response', name: 'AuthProvider.register'); // [NEW LOG]

      // æ³¨å†ŒæˆåŠŸåï¼Œé€šå¸¸ä¸ä¼šè‡ªåŠ¨ç™»å½•æˆ–è®¾ç½® tokenï¼Œåªè¿”å›æˆåŠŸçŠ¶æ€
      // å¦‚æœæ‚¨çš„ API è®¾è®¡æ˜¯æ³¨å†Œåè‡ªåŠ¨ç™»å½•ï¼Œåˆ™éœ€è¦åœ¨è¿™é‡Œå¤„ç† token å’Œ user

      _isLoading = false;
      developer.log('Registration successful. Notifying listeners.', name: 'AuthProvider.register'); // [NEW LOG]
      notifyListeners();
      return true; // è¿”å› true è¡¨ç¤º API è°ƒç”¨æˆåŠŸ

    } catch (e, stackTrace) { // [MODIFIED] æ•è·å †æ ˆè·Ÿè¸ª
      // [MODIFIED] æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
      _error = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.toString()}";
      _isLoading = false;
       // **** è¿™é‡Œæ·»åŠ äº†æ›´è¯¦ç»†çš„æ—¥å¿— ****
      developer.log(
        'Registration failed!', 
        name: 'AuthProvider.register', 
        error: e, 
        stackTrace: stackTrace
      );
      notifyListeners();
      return false; // è¿”å› false è¡¨ç¤º API è°ƒç”¨å¤±è´¥
    }
  }

  Future<void> logout() async {
    _token = null;
    _user = null;
    // [REMOVED] ä¸å†éœ€è¦ setToken
    // _apiService.setToken('');
    developer.log('User logged out. Notifying listeners.', name: 'AuthProvider.logout'); // [NEW LOG]
    notifyListeners();
  }
}

camera_provider.dart:
import 'package:flutter/material.dart';
import '../models/camera.dart';
import '../services/api_service.dart';

class CameraProvider with ChangeNotifier {
  final ApiService _apiService;

  List<Camera> _cameras = [];
  bool _isLoading = true;
  String? _error;
  Camera? _selectedCamera; // [FIX] çŠ¶æ€ç®¡ç†ä¸­æ·»åŠ  selectedCamera

  List<Camera> get cameras => _cameras;
  bool get isLoading => _isLoading;
  String? get error => _error;
  Camera? get selectedCamera => _selectedCamera; // [FIX] æ·»åŠ  getter

  CameraProvider(this._apiService) {
    fetchCameras();
  }

  // [FIX] æ·»åŠ  selectCamera æ–¹æ³•
  void selectCamera(Camera camera) {
    _selectedCamera = camera;
    notifyListeners();
  }

  Future<void> fetchCameras() async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      // _apiService.getCameras() å·²ç»è¿”å›äº† List<dynamic>
      final List<dynamic> response = await _apiService.getCameras();

      // [FIXED] 'response' æœ¬èº«å°±æ˜¯åˆ—è¡¨, ä¸å†éœ€è¦ ['data']
      final List<dynamic> cameraData = response;

      _cameras = cameraData
          .map((data) => Camera.fromJson(data as Map<String, dynamic>))
          .toList();
      
      // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ‘„åƒå¤´
      if (_cameras.isNotEmpty) {
        _selectedCamera = _cameras.first;
      }

    } catch (e) {
      _error = "ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.toString()}";
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}

report_detail_provider.dart:
import 'package:flutter/material.dart';
import '../models/report_detail.dart';
import '../services/api_service.dart';

enum FeedbackStatus { idle, loading, success }

class ReportDetailProvider with ChangeNotifier {
  final ApiService _apiService;

  ReportDetail? _reportDetail;
  bool _isLoading = true;
  String? _error;

  // Feedback state
  FeedbackStatus _feedbackStatus = FeedbackStatus.idle;
  String _selectedReason = 'äººãŒæ˜ ã£ã¦ã„ãªã„'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  String _feedbackNotes = '';
  int? _currentImageIdForFeedback;

  ReportDetail? get reportDetail => _reportDetail;
  bool get isLoading => _isLoading;
  String? get error => _error;
  FeedbackStatus get feedbackStatus => _feedbackStatus;
  String get selectedReason => _selectedReason;
  String get feedbackNotes => _feedbackNotes;
  int? get currentImageIdForFeedback => _currentImageIdForFeedback;

  final List<String> errorReasons = [
    'äººãŒæ˜ ã£ã¦ã„ãªã„',
    'å±é™ºãªè¡Œå‹•ãŒãªã„',
    'å±é™ºã®åˆ¤æ–­ã«èª¤ã‚ŠãŒã‚ã‚‹',
    'å±é™ºåˆ¤æ–­ã®ç¨®é¡ã«èª¤ã‚ŠãŒã‚ã‚‹',
    'é…å»¶ãŒç™ºç”Ÿã™ã‚‹ï¼ç”»åƒãŒç ´æã—ã¦ã„ã‚‹ï¼ç”»è³ªãŒæ‚ªã„ï¼ç”»åƒãŒå…¨ãåˆã£ã¦ã„ãªã„',
  ];

  ReportDetailProvider(this._apiService);

  void resetFeedbackState() {
    _feedbackStatus = FeedbackStatus.idle;
    _feedbackNotes = '';
    _selectedReason = errorReasons.first;
    _currentImageIdForFeedback = null;
    notifyListeners();
  }

  void updateSelectedReason(String? newValue) {
    if (newValue != null) {
      _selectedReason = newValue;
      notifyListeners();
    }
  }

  void updateFeedbackNotes(String notes) {
    _feedbackNotes = notes;
    notifyListeners();
  }

  void prepareFeedback(int imageId) {
    _currentImageIdForFeedback = imageId;
    _feedbackStatus = FeedbackStatus.idle;
    notifyListeners();
  }


Future<void> fetchReportDetail(String caseId) async {
  _isLoading = true;
  _error = null;
  _reportDetail = null;
  notifyListeners();

  try {
    print('ğŸ”µ Provider: Fetching report detail for caseId: $caseId'); // æ·»åŠ æ—¥å¿—
    
    final Map<String, dynamic> data = await _apiService.getEventDetail(caseId);
    
    print('âœ… Provider: Received data: $data'); // æ·»åŠ æ—¥å¿—
    
    if (data == null) {
      throw Exception('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
    }
    
    _reportDetail = ReportDetail.fromJson(data);
    print('âœ… Provider: ReportDetail parsed successfully'); // æ·»åŠ æ—¥å¿—
    
  } catch (e, stackTrace) {
    print('âŒ Provider ERROR: $e');
    print('Stack trace: $stackTrace');
    _error = 'ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.toString()}';
    _reportDetail = null;
  } finally {
    _isLoading = false;
    notifyListeners();
  }
}

  Future<void> submitFeedback({
    required String eventId, // [FIX] APIã‚µãƒ¼ãƒ“ã‚¹ã«åˆã‚ã›ã¦ String ã«å¤‰æ›´
    required int imageId,
    required String reason,
    required String notes,
  }) async {
    _feedbackStatus = FeedbackStatus.loading;
    notifyListeners();

    try {
      // [FIX] å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¸¡ã™
      await _apiService.submitFeedback(
        eventId: eventId,
        imageId: imageId,
        reason: reason,
        notes: notes,
      );
      _feedbackStatus = FeedbackStatus.success;
    } catch (e) {
      _error = "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.toString()}";
      _feedbackStatus = FeedbackStatus.idle; // å¤±æ•—ã—ãŸã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã«æˆ»ã™
    } finally {
      notifyListeners();
    }
  }
}

report_provider.dart:
import 'package:flutter/material.dart';
import '../models/report_case.dart'; // å¯¼å…¥æ­£ç¡®çš„ ReportCase æ¨¡å‹
import '../services/api_service.dart';

// è¿™æ˜¯ ReportProvider æ­£ç¡®çš„ç±»å®šä¹‰
class ReportProvider with ChangeNotifier {
  final ApiService _apiService; // å°†ç”± ProxyProvider æ³¨å…¥

  List<ReportCase> _reports = [];
  bool _isLoading = false;
  String? _error;
  DateTimeRange _selectedDateRange;
  Map<String, dynamic>? _paginationInfo;

  List<ReportCase> get reports => _reports;
  bool get isLoading => _isLoading;
  String? get error => _error;
  DateTimeRange get selectedDateRange => _selectedDateRange;

  // æ„é€ å‡½æ•°ç°åœ¨æ¥æ”¶ ApiService
  ReportProvider(this._apiService)
      : _selectedDateRange = DateTimeRange(
          start: DateTime.now().subtract(const Duration(days: 7)),
          end: DateTime.now(),
        ) {
    // æ„é€ å‡½æ•°ä¸­è‡ªåŠ¨è·å–ä¸€æ¬¡æ•°æ®
    // æ³¨æ„ï¼šå¦‚æœ ApiService åˆå§‹æ—¶æ²¡æœ‰ token, è¿™æ¬¡ fetch ä¼šå¤±è´¥
    // æ›´å¥½çš„åšæ³•æ˜¯åœ¨ MainScreen æˆ– ReportHistoryScreen çš„ initState ä¸­è°ƒç”¨
    // fetchReports(); 
    // ^ æˆ‘ä»¬åœ¨ report_history_screen.dart çš„ initState ä¸­è°ƒç”¨å®ƒï¼Œæ‰€ä»¥è¿™é‡Œæ³¨é‡Šæ‰
  }

  Future<void> fetchReports({DateTimeRange? dateRange, int page = 1}) async {
    // å¦‚æœæä¾›äº†æ–°çš„æ—¥æœŸèŒƒå›´ï¼Œåˆ™æ›´æ–°
    if (dateRange != null) {
      _selectedDateRange = dateRange;
    }

    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final Map<String, dynamic> response = await _apiService.getEvents(
        dateRange: _selectedDateRange,
        page: page,
      );

      final List<dynamic> responseData = response['data'] as List<dynamic>;
      _paginationInfo = response['pagination'] as Map<String, dynamic>;

      _reports = responseData
          .map((data) => ReportCase.fromJson(data as Map<String, dynamic>))
          .toList();
    } catch (e) {
      _error = "ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.toString()}";
      _reports = []; // å‘ç”Ÿé”™è¯¯æ—¶æ¸…ç©ºåˆ—è¡¨
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}

live_monitoring_screen.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/camera_provider.dart';
import '../models/camera.dart';

class LiveMonitoringScreen extends StatelessWidget {
  const LiveMonitoringScreen({super.key});

  @override
  Widget build(BuildContext context) {
    // [FIX] ä½¿ç”¨ Consumer æ¥ç›‘å¬ CameraProvider çš„å˜åŒ–
    return Consumer<CameraProvider>(
      builder: (context, cameraProvider, child) {
        if (cameraProvider.isLoading && cameraProvider.cameras.isEmpty) {
          return const Center(child: CircularProgressIndicator());
        }

        if (cameraProvider.error != null) {
          return Center(child: Text(cameraProvider.error!));
        }

        if (cameraProvider.cameras.isEmpty) {
          return const Center(child: Text('åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'));
        }

        // ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
        return Column(
          children: [
            // 1. ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢
            _buildVideoPlayer(context, cameraProvider.selectedCamera),
            
            // 2. ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«
            _buildListHeader(context),
            
            // 3. ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆ
            _buildCameraList(cameraProvider),
          ],
        );
      },
    );
  }

  // ãƒ“ãƒ‡ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
  Widget _buildVideoPlayer(BuildContext context, Camera? selectedCamera) {
    return AspectRatio(
      aspectRatio: 16 / 9,
      child: Container(
        width: double.infinity,
        color: Colors.black,
        child: Center(
          child: selectedCamera == null
              ? const Text('ã‚«ãƒ¡ãƒ©ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', style: TextStyle(color: Colors.white))
              : (selectedCamera.status == 'online'
                  ? Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.videocam, color: Colors.green, size: 64),
                        const SizedBox(height: 16),
                        Text(
                          '${selectedCamera.name} ã®æ˜ åƒ (ãƒ‡ãƒ¢)',
                          style: const TextStyle(color: Colors.white, fontSize: 18),
                        ),
                        const Text(
                          'ï¼ˆå®Ÿéš›ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰',
                          style: TextStyle(color: Colors.grey, fontSize: 14),
                        ),
                      ],
                    )
                  : Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.videocam_off, color: Colors.red, size: 64),
                        const SizedBox(height: 16),
                        Text(
                          '${selectedCamera.name} ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™',
                          style: const TextStyle(color: Colors.white, fontSize: 18),
                        ),
                      ],
                    )),
        ),
      ),
    );
  }

  // ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼
  Widget _buildListHeader(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 16, 16, 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            'ã‚«ãƒ¡ãƒ©ä¸€è¦§',
            style: Theme.of(context).textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
          ),
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () {
              // ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
              context.read<CameraProvider>().fetchCameras();
            },
          )
        ],
      ),
    );
  }

  // ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆ
  Widget _buildCameraList(CameraProvider provider) {
    return Expanded(
      child: ListView.builder(
        itemCount: provider.cameras.length,
        itemBuilder: (context, index) {
          final camera = provider.cameras[index];
          // [FIX] provider.selectedCamera?.id ã§å®‰å…¨ã«æ¯”è¼ƒ
          final isSelected = provider.selectedCamera?.id == camera.id;

          return Card(
            margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
            elevation: isSelected ? 4 : 1,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
              side: BorderSide(
                color: isSelected ? Colors.blue : Colors.transparent,
                width: 2,
              ),
            ),
            child: ListTile(
              leading: Icon(
                camera.status == 'online' ? Icons.videocam : Icons.videocam_off,
                color: camera.status == 'online' ? Colors.green : Colors.red,
              ),
              title: Text(
                camera.name,
                style: const TextStyle(fontWeight: FontWeight.bold),
              ),
              // [FIXED] camera.location -> camera.name
              // APIã¯ 'name' ã‚’è¿”ã™ãŒã€'location' ã¯è¿”ã•ãªã„
              // ã“ã“ã§ã¯ã‚«ãƒ¡ãƒ©åã‚’ subtitle ã«è¡¨ç¤ºã™ã‚‹ï¼ˆã‚‚ã—ãã¯ status ã‚’è¡¨ç¤ºã™ã‚‹ï¼‰
              subtitle: Text(
                camera.status == 'online' ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³',
                style: TextStyle(
                  color: camera.status == 'online' ? Colors.green : Colors.red,
                ),
              ),
              trailing: isSelected
                  ? const Icon(Icons.check_circle, color: Colors.blue)
                  : const Icon(Icons.arrow_forward_ios, color: Colors.grey, size: 16),
              onTap: () {
                // [FIX] provider.selectCamera ã‚’å‘¼ã³å‡ºã™
                provider.selectCamera(camera);
              },
            ),
          );
        },
      ),
    );
  }
}

login_screen.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import 'register_screen.dart'; 
import 'main_screen.dart'; 

// 
// å ä½ç¬¦
final Widget homeScreenForNavigation = const MainScreen();
final Widget registerScreenForNavigation = const RegisterScreen();


class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  final _usernameController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _isPasswordVisible = false;

  @override
  void dispose() {
    _usernameController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  Future<void> _submit() async {
    // Hide keyboard
    FocusScope.of(context).unfocus();
    
    // 
    // if (!_formKey.currentState!.validate()) {
    //   return;
    // }

    final authProvider = Provider.of<AuthProvider>(context, listen: false);

    final success = await authProvider.login(
      _usernameController.text.trim(),
      _passwordController.text.trim(),
    );

    if (mounted) {
      if (success) {
        // Navigate to home screen on successful login
        Navigator.of(context).pushReplacement(
          MaterialPageRoute(builder: (_) => homeScreenForNavigation),
        );
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(authProvider.error ?? 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'),
            backgroundColor: Theme.of(context).colorScheme.error,
          ),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {

    final authProvider = context.watch<AuthProvider>();

    return Scaffold(
      appBar: AppBar(
        title: const Text('ãƒ­ã‚°ã‚¤ãƒ³'),
        centerTitle: true,
      ),
      body: Center(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(24.0),
          child: Form(
            key: _formKey,
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              crossAxisAlignment: CrossAxisAlignment.stretch,
              children: [
                // App Logo
                // const FlutterLogo(size: 80),
                const SizedBox(height: 20),
                Text(
                  'ã‚ˆã†ã“ã',
                  style: Theme.of(context).textTheme.headlineMedium?.copyWith(fontWeight: FontWeight.bold),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 8),
                Text(
                  'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(color: Colors.grey[600]),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 40),
                TextFormField(
                  controller: _usernameController,
                  decoration: const InputDecoration(
                    labelText: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
                    prefixIcon: Icon(Icons.person_outline),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.all(Radius.circular(12)),
                    ),
                  ),
                  validator: (value) {
                    if (value == null || value.trim().isEmpty) {
                      return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    }
                    return null;
                  },
                ),
                const SizedBox(height: 20),
                TextFormField(
                  controller: _passwordController,
                  obscureText: !_isPasswordVisible,
                  decoration: InputDecoration(
                    labelText: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
                    prefixIcon: const Icon(Icons.lock_outline),
                    border: const OutlineInputBorder(
                      borderRadius: BorderRadius.all(Radius.circular(12)),
                    ),
                    suffixIcon: IconButton(
                      icon: Icon(
                        _isPasswordVisible ? Icons.visibility_off : Icons.visibility,
                      ),
                      onPressed: () {
                        setState(() {
                          _isPasswordVisible = !_isPasswordVisible;
                        });
                      },
                    ),
                  ),
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    }
                    return null;
                  },
                ),
                const SizedBox(height: 30),
                authProvider.isLoading
                    ? const Center(child: CircularProgressIndicator())
                    : ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        onPressed: _submit,
                        child: const Text('ãƒ­ã‚°ã‚¤ãƒ³'),
                      ),
                const SizedBox(height: 20),
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Text('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ'),
                    TextButton(
                      onPressed: authProvider.isLoading ? null : () {
                        // Navigate to register screen
                         Navigator.of(context).push(
                           MaterialPageRoute(builder: (_) => registerScreenForNavigation),
                         );
                      },
                      child: const Text('æ–°è¦ç™»éŒ²'),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


main_screen.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import '../providers/auth_provider.dart';
import 'live_monitoring_screen.dart';
import 'report_history_screen.dart';
import 'mypage_screen.dart';
import 'login_screen.dart';

class MainScreen extends StatefulWidget {
  const MainScreen({super.key});

  @override
  State<MainScreen> createState() => _MainScreenState();
}

class _MainScreenState extends State<MainScreen> {
  int _selectedIndex = 0;

  // å¯¼èˆªæ å¯¹åº”çš„é¡µé¢åˆ—è¡¨
  static const List<Widget> _widgetOptions = <Widget>[
    LiveMonitoringScreen(),
    ReportHistoryScreen(),
    MypageScreen(),
  ];

  // å¯¼èˆªæ å¯¹åº”çš„æ ‡é¢˜åˆ—è¡¨
  static const List<String> _appBarTitles = <String>[
    'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–',
    'ãƒ¬ãƒãƒ¼ãƒˆå±¥æ­´',
    'ãƒã‚¤ãƒšãƒ¼ã‚¸',
  ];

  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
  }

  @override
  Widget build(BuildContext context) {
    final authProvider = context.watch<AuthProvider>();

    return Scaffold(
      appBar: AppBar(
        title: Text(_appBarTitles[_selectedIndex]),
        centerTitle: true,
        actions: [
          IconButton(
            icon: const Icon(Icons.logout),
            tooltip: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
            onPressed: () {
              // AuthProviderãƒ¼logout
              Provider.of<AuthProvider>(context, listen: false).logout();
              // back to login
              Navigator.of(context).pushAndRemoveUntil(
                MaterialPageRoute(builder: (context) => const LoginScreen()),
                (Route<dynamic> route) => false,
              );
            },
          )
        ],
      ),
      body: IndexedStack(
        index: _selectedIndex,
        children: _widgetOptions,
      ),
      bottomNavigationBar: BottomNavigationBar(
        items: const <BottomNavigationBarItem>[
          BottomNavigationBarItem(
            icon: Icon(Icons.videocam_outlined),
            activeIcon: Icon(Icons.videocam),
            label: 'ç›£è¦–',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.history_outlined),
            activeIcon: Icon(Icons.history),
            label: 'å±¥æ­´',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.person_outline),
            activeIcon: Icon(Icons.person),
            label: 'ãƒã‚¤ãƒšãƒ¼ã‚¸',
          ),
        ],
        currentIndex: _selectedIndex,
        onTap: _onItemTapped,
        selectedItemColor: Theme.of(context).colorScheme.primary, // é¸æŠæ™‚ã®è‰²
        unselectedItemColor: Colors.grey, // éé¸æŠæ™‚ã®è‰²
        showUnselectedLabels: true, // éé¸æŠæ™‚ã®ãƒ©ãƒ™ãƒ«ã‚‚è¡¨ç¤º
        type: BottomNavigationBarType.fixed, // ã‚¢ã‚¤ãƒ†ãƒ ã®æŒ™å‹•ã‚’å›ºå®š
      ),
    );
  }
}
mypage_screen.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import 'login_screen.dart';
import 'periodic_report_screen.dart'; 

class MypageScreen extends StatelessWidget {
  const MypageScreen({super.key});

  @override
  Widget build(BuildContext context) {

    final authProvider = context.watch<AuthProvider>();
    final user = authProvider.user;

    return Scaffold(
      // èƒŒæ™¯è‰²ã‚’è¨­å®š
      backgroundColor: Colors.grey[100],
      body: CustomScrollView(
        slivers: [
          SliverAppBar(
            backgroundColor: Colors.transparent,
            elevation: 0,
            expandedHeight: 220.0,
            flexibleSpace: FlexibleSpaceBar(
              background: _buildHeader(context, user?.username ?? 'Guest'),
            ),
          ),
          SliverToBoxAdapter(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  _buildSectionTitle(context, 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š'),
                  _buildOptionCard(
                    context,
                    options: [
                      _buildListTile(
                        context,
                        icon: Icons.person_outline,
                        title: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†',
                        onTap: () {},
                      ),
                      _buildListTile(
                        context,
                        icon: Icons.lock_outline,
                        title: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´',
                        onTap: () {},
                      ),
                      _buildListTile(
                        context,
                        icon: Icons.email_outlined,
                        title: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´',
                        onTap: () {},
                      ),
                    ],
                  ),
                  const SizedBox(height: 24),
                  _buildSectionTitle(context, 'ãã®ä»–'),
                  _buildOptionCard(
                    context,
                    options: [
                      _buildListTile( // [ADDED] Start
                        context,
                        icon: Icons.bar_chart_outlined,
                        title: 'å®šæœŸãƒ¬ãƒãƒ¼ãƒˆ',
                        onTap: () {
                          Navigator.of(context).push(MaterialPageRoute(
                            builder: (_) => const PeriodicReportScreen(),
                          ));
                        },
                      ), // [ADDED] End
                      _buildListTile(
                        context,
                        icon: Icons.help_outline,
                        title: 'ãƒ˜ãƒ«ãƒ—',
                        onTap: () {},
                      ),
                      _buildListTile(
                        context,
                        icon: Icons.description_outlined,
                        title: 'åˆ©ç”¨è¦ç´„',
                        onTap: () {},
                      ),
                      _buildListTile(
                        context,
                        icon: Icons.privacy_tip_outlined,
                        title: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼',
                        onTap: () {},
                      ),
                      _buildListTile(
                        context,
                        icon: Icons.logout,
                        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
                        isLogout: true,
                        onTap: () {
                          // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
                          context.read<AuthProvider>().logout();
                          // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                          Navigator.of(context, rootNavigator: true)
                              .pushAndRemoveUntil(
                            MaterialPageRoute(
                                builder: (context) => const LoginScreen()),
                            (route) => false,
                          );
                        },
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }


  Widget _buildHeader(BuildContext context, String username) {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            Theme.of(context).primaryColor,
            Theme.of(context).primaryColor.withOpacity(0.7)
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
      ),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const CircleAvatar(
              radius: 40,
              backgroundColor: Colors.white,
              child: Icon(
                Icons.person,
                size: 50,
                color: Colors.blueAccent,
              ),
            ),
            const SizedBox(height: 12),
            Text(
              username,
              style: Theme.of(context)
                  .textTheme
                  .headlineMedium
                  ?.copyWith(color: Colors.white, fontWeight: FontWeight.bold),
            ),
          ],
        ),
      ),
    );
  }


  Widget _buildSectionTitle(BuildContext context, String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(
        title,
        style: Theme.of(context)
            .textTheme
            .titleMedium
            ?.copyWith(color: Colors.grey.shade600),
      ),
    );
  }


  Widget _buildOptionCard(BuildContext context,
      {required List<Widget> options}) {
    return Card(
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(color: Colors.grey.shade300),
      ),
      clipBehavior: Clip.antiAlias,
      child: Column(
        children: options,
      ),
    );
  }


  Widget _buildListTile(BuildContext context,
      {required IconData icon,
      required String title,
      required VoidCallback onTap,
      bool isLogout = false}) {
    final color = isLogout ? Colors.red : Colors.black;
    return Material(
      color: Colors.white,
      child: InkWell(
        onTap: onTap,
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 12.0),
          child: Row(
            children: [
              Icon(icon, color: color),
              const SizedBox(width: 16),
              Expanded(
                child: Text(
                  title,
                  style: Theme.of(context)
                      .textTheme
                      .bodyLarge
                      ?.copyWith(color: color),
                ),
              ),
              if (!isLogout)
                const Icon(Icons.arrow_forward_ios,
                    size: 16, color: Colors.grey),
            ],
          ),
        ),
      ),
    );
  }
}


periodic_report_screen.dart:
import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../services/api_service.dart';

// [MODIFIED] è½¬æ¢ä¸º StatefulWidget ä»¥ç®¡ç†çŠ¶æ€
class PeriodicReportScreen extends StatefulWidget {
  const PeriodicReportScreen({super.key});

  @override
  State<PeriodicReportScreen> createState() => _PeriodicReportScreenState();
}

class _PeriodicReportScreenState extends State<PeriodicReportScreen> {
  // --- çŠ¶æ€å˜é‡ ---
  bool _isLoading = true;
  String? _error;
  // ç”¨äºå­˜å‚¨ä» API G/api/reports è¿”å›çš„å®Œæ•´ JSON å¯¹è±¡
  Map<String, dynamic>? _reportData;

  @override
  void initState() {
    super.initState();
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
    _fetchReportData();
  }

  // --- æ•°æ®è·å–æ–¹æ³• ---
  Future<void> _fetchReportData() async {
    // ä½¿ç”¨ Provider.of è·å–ç”± ProxyProvider æä¾›çš„ã€å·²è®¤è¯çš„ ApiService å®ä¾‹
    final apiService = Provider.of<ApiService>(context, listen: false);

    try {
      final data = await apiService.getPeriodicReport();
      setState(() {
        _reportData = data;
        _isLoading = false;
      });
    } catch (e) {
      setState(() {
        _error = "ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.toString()}";
        _isLoading = false;
      });
    }
  }

  // --- ä¸»æ„å»ºæ–¹æ³• ---
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('å®šæœŸãƒ¬ãƒãƒ¼ãƒˆ'),
        actions: [
          // æ·»åŠ ä¸€ä¸ªåˆ·æ–°æŒ‰é’®
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: _isLoading ? null : _fetchReportData,
          ),
        ],
      ),
      body: _buildBody(), // [MODIFIED] ä½¿ç”¨ _buildBody æ¥å¤„ç†çŠ¶æ€
    );
  }

  // --- çŠ¶æ€å¤„ç† ---
  Widget _buildBody() {
    if (_isLoading) {
      return const Center(child: CircularProgressIndicator());
    }
    if (_error != null) {
      return Center(
        child: Padding(
          padding: const EdgeInsets.all(16.0),
          child: Text(_error!,
              style: const TextStyle(color: Colors.red, fontSize: 16),
              textAlign: TextAlign.center),
        ),
      );
    }
    if (_reportData == null || _reportData!['success'] != true) {
      return const Center(child: Text('ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'));
    }

    // --- æ•°æ®è§£æ ---
    // [MODIFIED] ä» _reportData ä¸­è§£ææ•°æ®
    // æˆ‘ä»¬å‡è®¾ _reportData åŒ…å«äº† API è§„èŒƒä¸­å®šä¹‰çš„æ‰€æœ‰é”®
    final headerData = _reportData!['dashboard_header'] as Map<String, dynamic>;
    final metricsData = _reportData!['model_performance'] as Map<String, dynamic>;
    final statsData = _reportData!['incident_stats'] as Map<String, dynamic>;
    final comparisonData =
        _reportData!['model_comparison'] as Map<String, dynamic>;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          // [MODIFIED] ä¼ é€’è§£æåçš„æ•°æ®
          _buildHeader(context, headerData),
          const SizedBox(height: 24),
          _buildModelMetrics(context, metricsData),
          const SizedBox(height: 24),
          _buildIncidentStats(context, statsData),
          const SizedBox(height: 24),
          _buildModelComparisonTable(context, comparisonData),
        ],
      ),
    );
  }

  // --- å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ãƒ¡ã‚½ãƒƒãƒ‰ ---

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  Widget _buildHeader(
      BuildContext context, Map<String, dynamic> headerData) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          colors: [Color(0xFF0D6EFD), Color(0xFF6F42C1)],
          begin: Alignment.centerLeft,
          end: Alignment.centerRight,
        ),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        children: [
          Text(
            headerData['title'] ?? 'å…¬åœ’å†…äº‹æ•…äºˆæ¸¬ãƒ¢ãƒ‡ãƒ« åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
            style: Theme.of(context)
                .textTheme
                .headlineSmall
                ?.copyWith(color: Colors.white, fontWeight: FontWeight.bold),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 8),
          Text(
            // [MODIFIED]
            'ç¾åœ¨ç¨¼åƒä¸­ã®ãƒ¢ãƒ‡ãƒ«: ${headerData['current_model'] ?? 'N/A'}',
            style: Theme.of(context)
                .textTheme
                .titleMedium
                ?.copyWith(color: Colors.white70),
          ),
        ],
      ),
    );
  }

  // ãƒ¢ãƒ‡ãƒ«ã®è©•ä¾¡æŒ‡æ¨™ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  Widget _buildModelMetrics(
      BuildContext context, Map<String, dynamic> metricsData) {
    // [MODIFIED] ä» metricsData è§£ææ•°æ®
    // ä½¿ç”¨ .map å°† List<dynamic> å®‰å…¨è½¬æ¢ä¸º List<double>
    final precision = (metricsData['precision_data'] as List)
        .map((e) => (e as num).toDouble())
        .toList();
    final recall = (metricsData['recall_data'] as List)
        .map((e) => (e as num).toDouble())
        .toList();
    final f1score = (metricsData['f1_score_data'] as List)
        .map((e) => (e as num).toDouble())
        .toList();

    return Column(
      children: [
        _buildChartCard(
          context,
          title: 'ãƒ¢ãƒ‡ãƒ«ã®é©åˆç‡ (Precision)',
          chart: _buildLineChart(
            data: precision.isNotEmpty ? precision : [0], // [MODIFIED]
            color: Colors.blue,
          ),
        ),
        const SizedBox(height: 16),
        _buildChartCard(
          context,
          title: 'ãƒ¢ãƒ‡ãƒ«ã®å†ç¾ç‡ (Recall)',
          chart: _buildLineChart(
            data: recall.isNotEmpty ? recall : [0], // [MODIFIED]
            color: Colors.red,
          ),
        ),
        const SizedBox(height: 16),
        _buildChartCard(
          context,
          title: 'ãƒ¢ãƒ‡ãƒ«ã®F1-Score',
          chart: _buildLineChart(
            data: f1score.isNotEmpty ? f1score : [0], // [MODIFIED]
            color: Colors.teal,
          ),
        ),
      ],
    );
  }

  // äº‹æ•…çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
  Widget _buildIncidentStats(
      BuildContext context, Map<String, dynamic> statsData) {
    // [MODIFIED] è§£ææ•°æ®
    final totalIncidents = statsData['total_incidents']?.toString() ?? '0';
    final categoryData =
        (statsData['category_distribution'] as List).cast<Map<String, dynamic>>();
    final hourlyData =
        (statsData['hourly_distribution'] as List).cast<Map<String, dynamic>>();

    return Column(
      children: [
        Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Expanded(
              flex: 2,
              child: _buildMetricCard(
                context,
                label: 'ä»Šæœˆã®äº‹æ•…ç™ºç”Ÿä»¶æ•°',
                value: totalIncidents, // [MODIFIED]
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              flex: 3,
              child: _buildChartCard(
                context,
                title: 'äº‹æ•…ã®åˆ†é¡',
                chart: _buildPieChart(categoryData), // [MODIFIED]
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),
        _buildChartCard(
          context,
          title: 'æ™‚é–“å¸¯åˆ¥ã®äº‹æ•…ç™ºç”ŸçŠ¶æ³',
          chart: _buildBarChart(hourlyData), // [MODIFIED]
        ),
      ],
    );
  }

  // ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«
  Widget _buildModelComparisonTable(
      BuildContext context, Map<String, dynamic> comparisonData) {
    // [MODIFIED] è§£ææ•°æ®
    final models =
        (comparisonData['models'] as List).cast<Map<String, dynamic>>();

    return _buildDashboardCard(
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(comparisonData['title'] ?? 'æœ€è¿‘3ã¤ã®ãƒ¢ãƒ‡ãƒ«ã®F1-Scoreæ¯”è¼ƒ',
                style: Theme.of(context).textTheme.titleLarge),
            const SizedBox(height: 16),
            // [MODIFIED] åŠ¨æ€ç”Ÿæˆè¡¨æ ¼è¡Œ
            ...models.asMap().entries.map((entry) {
              final model = entry.value;
              final bool isLast = entry.key == models.length - 1;
              final status = model['status'] ?? 'æ—§';
              final progress = (model['f1_score'] as num? ?? 0.0).toDouble();

              return Column(
                children: [
                  _buildComparisonTableRow(
                    context,
                    modelName: model['name'] ?? 'N/A',
                    score: '${(progress * 100).toStringAsFixed(2)}%',
                    status: status,
                    statusColor:
                        status == 'ç¨¼åƒä¸­' ? Colors.green : Colors.grey,
                    progress: progress,
                    progressColor:
                        status == 'ç¨¼åƒä¸­' ? Colors.green : Colors.blueGrey,
                  ),
                  if (!isLast) const Divider(),
                ],
              );
            }),
          ],
        ),
      ),
    );
  }

  // --- å…±é€šãƒ»å€‹åˆ¥ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ ---

  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ«
  Widget _buildDashboardCard({required Widget child}) {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: child,
    );
  }

  // ãƒãƒ£ãƒ¼ãƒˆç”¨ã®ã‚«ãƒ¼ãƒ‰
  Widget _buildChartCard(BuildContext context,
      {required String title, required Widget chart}) {
    return _buildDashboardCard(
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            Text(title, style: Theme.of(context).textTheme.titleLarge),
            const SizedBox(height: 24),
            SizedBox(height: 200, child: chart),
          ],
        ),
      ),
    );
  }

  // æ•°å€¤è¡¨ç¤ºç”¨ã®ã‚«ãƒ¼ãƒ‰
  Widget _buildMetricCard(BuildContext context,
      {required String label, required String value}) {
    return _buildDashboardCard(
      child: Container(
        height: 264, // PieChartã®é«˜ã•ã«åˆã‚ã›ã‚‹
        padding: const EdgeInsets.all(16.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(
              value,
              style: Theme.of(context)
                  .textTheme
                  .displayMedium
                  ?.copyWith(fontWeight: FontWeight.bold, color: Colors.blue),
            ),
            const SizedBox(height: 8),
            Text(
              label,
              style: Theme.of(context).textTheme.bodyLarge,
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }

  // æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œ
  Widget _buildComparisonTableRow(
    BuildContext context, {
    required String modelName,
    required String score,
    required String status,
    required Color statusColor,
    required double progress,
    required Color progressColor,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(modelName, style: Theme.of(context).textTheme.titleMedium),
              Container(
                padding:
                    const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: statusColor,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(status,
                    style: const TextStyle(color: Colors.white, fontSize: 12)),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Row(
            children: [
              Expanded(
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(8),
                  child: LinearProgressIndicator(
                    value: progress,
                    minHeight: 20,
                    backgroundColor: progressColor.withOpacity(0.2),
                    valueColor: AlwaysStoppedAnimation<Color>(progressColor),
                  ),
                ),
              ),
              const SizedBox(width: 16),
              Text(score,
                  style: Theme.of(context)
                      .textTheme
                      .titleMedium
                      ?.copyWith(fontWeight: FontWeight.bold)),
            ],
          ),
        ],
      ),
    );
  }

  // --- ãƒãƒ£ãƒ¼ãƒˆã®å®šç¾© ---

  // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
  Widget _buildLineChart({required List<double> data, required Color color}) {
    final spots = data
        .asMap()
        .entries
        .map((e) => FlSpot(e.key.toDouble(), e.value))
        .toList();

    return LineChart(
      LineChartData(
        gridData: FlGridData(show: false),
        titlesData: FlTitlesData(show: false),
        borderData: FlBorderData(show: false),
        lineBarsData: [
          LineChartBarData(
            spots: spots,
            isCurved: true,
            color: color,
            barWidth: 4,
            isStrokeCapRound: true,
            dotData: FlDotData(show: false),
            belowBarData: BarAreaData(
              show: true,
              color: color.withOpacity(0.2),
            ),
          ),
        ],
        minY: 0,
        maxY: 100,
      ),
    );
  }

  // å††ã‚°ãƒ©ãƒ•
  Widget _buildPieChart(List<Map<String, dynamic>> data) {
    if (data.isEmpty) return const Center(child: Text('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'));

    return PieChart(
      PieChartData(
        sectionsSpace: 4,
        centerSpaceRadius: 40,
        // [MODIFIED] åŠ¨æ€ç”Ÿæˆé¥¼å›¾
        sections: data.map((item) {
          final value = (item['value'] as num? ?? 0.0).toDouble();
          return PieChartSectionData(
              value: value,
              title: '${value.toStringAsFixed(0)}%', // API ãŒ % ã‚’è¿”ã™ã¨ä»®å®š
              color: _getColorForCategory(item['label'] ?? ''), // ãƒ˜ãƒ«ãƒ‘ãƒ¼ã§è‰²ã‚’æ±ºå®š
              radius: 50,
              titleStyle: const TextStyle(fontWeight: FontWeight.bold));
        }).toList(),
      ),
    );
  }

  // æ£’ã‚°ãƒ©ãƒ•
  Widget _buildBarChart(List<Map<String, dynamic>> data) {
    if (data.isEmpty) return const Center(child: Text('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'));

    final labels = data.map((item) => item['label'] as String? ?? '').toList();

    return BarChart(
      BarChartData(
        alignment: BarChartAlignment.spaceAround,
        gridData: FlGridData(show: false),
        titlesData: FlTitlesData(
          bottomTitles: AxisTitles(
            sideTitles: SideTitles(
              showTitles: true,
              getTitlesWidget: (value, meta) {
                final index = value.toInt();
                if (index < 0 || index >= labels.length) return Container();
                // [MODIFIED] åŠ¨æ€è®¾ç½®æ ‡ç­¾
                return Text(
                  labels[index].replaceAll('æ™‚', ''), // '12-14æ™‚' -> '12-14'
                  style: const TextStyle(fontSize: 10),
                );
              },
              reservedSize: 30,
            ),
          ),
          leftTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
          topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
          rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
        ),
        borderData: FlBorderData(show: false),
        // [MODIFIED] åŠ¨æ€ç”ŸæˆæŸ±çŠ¶å›¾
        barGroups: data.asMap().entries.map((entry) {
          final index = entry.key;
          final item = entry.value;
          final value = (item['value'] as num? ?? 0.0).toDouble();
          return BarChartGroupData(x: index, barRods: [
            BarChartRodData(
                toY: value,
                color: _getColorForCategory(item['label'] ?? '', index),
                width: 20)
          ]);
        }).toList(),
      ),
    );
  }

  // [ADDED] åŠ¨æ€é¢œè‰²çš„è¾…åŠ©å‡½æ•°
  Color _getColorForCategory(String category, [int index = 0]) {
    switch (category.toLowerCase()) {
      case 'slide':
      case 'æ»‘ã‚Šå°':
        return Colors.purple;
      case 'swing':
      case 'ãƒ–ãƒ©ãƒ³ã‚³':
        return Colors.orange;
      case 'junglegym':
      case 'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«ã‚¸ãƒ ':
        return Colors.teal;
      default:
        // æ£’ã‚°ãƒ©ãƒ•ã‚„å††ã‚°ãƒ©ãƒ•ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        final colors = [
          Colors.amber,
          Colors.blue,
          Colors.red,
          Colors.green,
          Colors.purple
        ];
        return colors[index % colors.length];
    }
  }
}

register_screen.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import 'dart:developer' as developer; // [NEW] å¯¼å…¥ developer

class RegisterScreen extends StatefulWidget {
  const RegisterScreen({super.key});

  @override
  State<RegisterScreen> createState() => _RegisterScreenState();
}

class _RegisterScreenState extends State<RegisterScreen> {
  final _formKey = GlobalKey<FormState>();
  final _usernameController = TextEditingController();
  final _emailController = TextEditingController();
  final _fullNameController = TextEditingController();
  final _passwordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();
  bool _obscurePassword = true;
  bool _obscureConfirmPassword = true;

  @override
  void dispose() {
    _usernameController.dispose();
    _emailController.dispose();
    _fullNameController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    super.dispose();
  }

  Future<void> _submitForm() async {
    // [DEBUG LOG] ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶è¢«è§¦å‘
    developer.log('Register button pressed. Attempting to submit form.', name: 'RegisterScreen._submitForm');

    // [DEBUG LOG] æ£€æŸ¥ _formKey æ˜¯å¦å­˜åœ¨
    developer.log('Form key state: ${_formKey.currentState}', name: 'RegisterScreen._submitForm');

    if (_formKey.currentState?.validate() ?? false) {
      // [DEBUG LOG] ç¡®è®¤è¡¨å•éªŒè¯é€šè¿‡
      developer.log('Form validation successful. Calling AuthProvider.register...', name: 'RegisterScreen._submitForm');

      final authProvider = context.read<AuthProvider>();
      try {
        final success = await authProvider.register(
          username: _usernameController.text,
          password: _passwordController.text,
          email: _emailController.text,
          fullName: _fullNameController.text,
        );

        if (success && mounted) {
           // [DEBUG LOG] ç¡®è®¤æ³¨å†ŒæˆåŠŸå›è°ƒ
           developer.log('AuthProvider.register returned success.', name: 'RegisterScreen._submitForm');
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒæˆåŠŸã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'),
              backgroundColor: Colors.green,
            ),
          );
          Navigator.of(context).pop(); // ç™»éŒ²æˆåŠŸå¾Œã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
        } else if (!success && mounted) {
           // [DEBUG LOG] ç¡®è®¤æ³¨å†Œå¤±è´¥å›è°ƒ (æ¥è‡ª Provider)
           developer.log('AuthProvider.register returned failure. Error: ${authProvider.error}', name: 'RegisterScreen._submitForm');
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${authProvider.error ?? 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}'),
              backgroundColor: Colors.red,
            ),
          );
        }
      } catch (e) {
         // [DEBUG LOG] æ•è· Provider è°ƒç”¨æœ¬èº«çš„å¼‚å¸¸
         developer.log('Exception caught while calling AuthProvider.register', name: 'RegisterScreen._submitForm', error: e);
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}'),
              backgroundColor: Colors.red,
            ),
          );
        }
      }
    } else {
       // [DEBUG LOG] ç¡®è®¤è¡¨å•éªŒè¯å¤±è´¥
       developer.log('Form validation failed.', name: 'RegisterScreen._submitForm');
    }
  }


  @override
  Widget build(BuildContext context) {
    // AuthProvider ã®çŠ¶æ…‹ã‚’ç›£è¦–ã—ã¦ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’åˆ¶å¾¡
    final isLoading = context.watch<AuthProvider>().isLoading;

    return Scaffold(
      appBar: AppBar(
        title: const Text('æ–°è¦ç™»éŒ²'),
      ),
      body: Stack( // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®ãŸã‚ã« Stack ã‚’ä½¿ç”¨
        children: [
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Form(
              key: _formKey,
              child: ListView( // SingleChildScrollView ã®ä»£ã‚ã‚Šã« ListView ã‚’ä½¿ã†ã¨ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ãªã©ãŒæ”¹å–„ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹
                children: [
                  TextFormField(
                    controller: _usernameController,
                    decoration: const InputDecoration(
                      labelText: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
                      prefixIcon: Icon(Icons.person),
                      border: OutlineInputBorder(),
                    ),
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      if (value.length < 3) {
                        return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),
                  TextFormField(
                    controller: _emailController,
                    decoration: const InputDecoration(
                      labelText: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
                      prefixIcon: Icon(Icons.email),
                      border: OutlineInputBorder(),
                    ),
                    keyboardType: TextInputType.emailAddress,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      // ç°¡å˜ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã®æ¤œè¨¼
                      if (!RegExp(r'\S+@\S+\.\S+').hasMatch(value)) {
                        return 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),
                  TextFormField(
                    controller: _fullNameController,
                    decoration: const InputDecoration(
                      labelText: 'æ°å',
                      prefixIcon: Icon(Icons.badge),
                      border: OutlineInputBorder(),
                    ),
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),
                  TextFormField(
                    controller: _passwordController,
                    decoration: InputDecoration(
                      labelText: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
                      prefixIcon: const Icon(Icons.lock),
                      border: const OutlineInputBorder(),
                      suffixIcon: IconButton(
                        icon: Icon(
                          _obscurePassword ? Icons.visibility_off : Icons.visibility,
                        ),
                        onPressed: () {
                          setState(() {
                            _obscurePassword = !_obscurePassword;
                          });
                        },
                      ),
                    ),
                    obscureText: _obscurePassword,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      if (value.length < 6) {
                        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),
                  TextFormField(
                    controller: _confirmPasswordController,
                    decoration: InputDecoration(
                      labelText: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ç¢ºèª)',
                      prefixIcon: const Icon(Icons.lock_outline),
                      border: const OutlineInputBorder(),
                       suffixIcon: IconButton(
                        icon: Icon(
                          _obscureConfirmPassword ? Icons.visibility_off : Icons.visibility,
                        ),
                        onPressed: () {
                          setState(() {
                            _obscureConfirmPassword = !_obscureConfirmPassword;
                          });
                        },
                      ),
                    ),
                    obscureText: _obscureConfirmPassword,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                      }
                      if (value != _passwordController.text) {
                        return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 32),
                  ElevatedButton(
                    onPressed: isLoading ? null : _submitForm, // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    style: ElevatedButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      textStyle: const TextStyle(fontSize: 18),
                    ),
                    child: const Text('ç™»éŒ²'),
                  ),
                ],
              ),
            ),
          ),
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’é‡ã­ã¦è¡¨ç¤º
          if (isLoading)
            Container(
              color: Colors.black.withOpacity(0.5), // èƒŒæ™¯ã‚’å°‘ã—æš—ãã™ã‚‹
              child: const Center(
                child: CircularProgressIndicator(),
              ),
            ),
        ],
      ),
    );
  }
}

report_detail_screen.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:intl/intl.dart';
import '../models/report_detail.dart';
import '../providers/report_detail_provider.dart';
import '../services/api_service.dart'; // [FIX] å¯¼å…¥ ApiService

class ReportDetailScreen extends StatefulWidget {
  final String caseId; // æ¥æ”¶ String ç±»å‹çš„ caseId

  const ReportDetailScreen({super.key, required this.caseId});

  @override
  State<ReportDetailScreen> createState() => _ReportDetailScreenState();
}

class _ReportDetailScreenState extends State<ReportDetailScreen> {
  final PageController _pageController = PageController();
  int _currentPage = 0;

  @override
  void initState() {
    super.initState();
    // ç”»é¢åˆæœŸåŒ–æ™‚ã«è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<ReportDetailProvider>().fetchReportDetail(widget.caseId);
    });

    _pageController.addListener(() {
      setState(() {
        _currentPage = _pageController.page?.round() ?? 0;
      });
    });
  }

  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°'),
      ),
      body: Consumer<ReportDetailProvider>(
        builder: (context, provider, child) {
          if (provider.isLoading) {
            return const Center(child: CircularProgressIndicator());
          }

          if (provider.error != null) {
            return Center(child: Text(provider.error!));
          }

          if (provider.reportDetail == null) {
            return const Center(child: Text('ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'));
          }

          final report = provider.reportDetail!;
          final currentImage = report.images.isNotEmpty
              ? report.images[_currentPage]
              : null;

          return Column(
            children: [
              // 1. ç”»åƒã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ (ç”»é¢ã®50%)
              Expanded(
                flex: 5, // 50%
                child: _buildImageSlider(report.images),
              ),
              // 2. è©³ç´°æƒ…å ± (ç”»é¢ã®50%)
              Expanded(
                flex: 5, // 50%
                child: _buildImageDetails(
                    context, report, currentImage, provider),
              ),
            ],
          );
        },
      ),
    );
  }

  // --- Widgets ---

  Widget _buildImageSlider(List<ImageDetail> images) {
  if (images.isEmpty) {
    return Container(
      color: Colors.grey[300],
      child: const Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.image_not_supported, color: Colors.grey, size: 64),
            SizedBox(height: 16),
            Text('é–¢é€£ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚', style: TextStyle(color: Colors.grey)),
          ],
        ),
      ),
    );
  }

  return PageView.builder(
    controller: _pageController,
    itemCount: images.length,
    itemBuilder: (context, index) {
      final image = images[index];
      return Container(
        color: Colors.black87,
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // æ˜¾ç¤ºç½‘ç»œå›¾ç‰‡
              Expanded(
                child: Padding(
                  padding: const EdgeInsets.all(8.0),
                  child: Image.network(
                    image.imageUrl,
                    fit: BoxFit.contain,
                    errorBuilder: (context, error, stackTrace) {
                      return const Icon(Icons.broken_image, color: Colors.white, size: 100);
                    },
                    loadingBuilder: (context, child, loadingProgress) {
                      if (loadingProgress == null) return child;
                      return const Center(
                        child: CircularProgressIndicator(color: Colors.white),
                      );
                    },
                  ),
                ),
              ),
              const SizedBox(height: 16),
              // å›¾ç‰‡æ ‡é¢˜
              Text(
                'ç”»åƒ ${image.imageId} (ãƒ‡ãƒ¢)',
                style: const TextStyle(color: Colors.white, fontSize: 16),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 8),
              Text(
                'Image URL: ${image.imageUrl}',
                style: const TextStyle(color: Colors.grey, fontSize: 12),
                textAlign: TextAlign.center,
              ),
            ],
          ),
        ),
      );
    },
  );
}


  Widget _buildImageDetails(BuildContext context, ReportDetail report,
      ImageDetail? currentImage, ReportDetailProvider provider) {
    if (currentImage == null) {
      return const Center(child: Text('ç”»åƒæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'));
    }

    final dateFormat = DateFormat('yyyy-MM-dd HH:mm:ss');
    bool hasSubmitted = provider.feedbackStatus == FeedbackStatus.success;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          // ç”»åƒã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
          Text(
            // [FIX] currentImage.imageId ã¯ int ãªã®ã§ .toString() ã‚’ä½¿ç”¨
            'ç”»åƒ ${currentImage.imageId.toString()} / ${report.imageCount}',
            style: Theme.of(context)
                .textTheme
                .titleMedium
                ?.copyWith(color: Colors.grey[700]),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),

          // æƒ…å ±ã‚«ãƒ¼ãƒ‰
          Card(
            elevation: 2,
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _buildDetailRow(context, 'ã‚¹ã‚³ã‚¢', currentImage.score.toString(),
                      isScore: true, score: currentImage.score),
                  const Divider(),
                  _buildDetailRow(
                      context, 'ç™ºç”Ÿæ™‚åˆ»', dateFormat.format(currentImage.timestamp)),
                  const Divider(),
                  _buildDetailRow(context, 'ã‚«ãƒ†ã‚´ãƒª', report.category),
                  const Divider(),
                  _buildDetailRow(
                      context, 'æ¤œçŸ¥ã•ã‚ŒãŸç”»åƒæ•°', report.imageCount.toString()),
                  const Divider(),
                  _buildDeductionList(context, currentImage.deductionItems),
                ],
              ),
            ),
          ),
          const SizedBox(height: 24),

          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³
          ElevatedButton.icon(
            icon: Icon(
              hasSubmitted ? Icons.check_circle : Icons.error_outline,
            ),
            label: Text(hasSubmitted ? 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡æ¸ˆã¿' : 'èª¤æ¤œçŸ¥ã‚’å ±å‘Š'),
            style: ElevatedButton.styleFrom(
              backgroundColor: hasSubmitted ? Colors.grey : Colors.red,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 16),
            ),
            // [FIX] æ—¢ã«é€ä¿¡æˆåŠŸã—ãŸå ´åˆã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            onPressed: hasSubmitted
                ? null
                : () {
                    // [FIX] ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾è±¡ã®ç”»åƒIDã‚’Providerã«ã‚»ãƒƒãƒˆ
                    provider.prepareFeedback(currentImage.imageId);
                    _showFeedbackDialog(context, provider, report.id.toString());
                  },
          ),
        ],
      ),
    );
  }

  // --- Feedback Dialog ---

  void _showFeedbackDialog(
      BuildContext context, ReportDetailProvider provider, String eventId) {
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯è‡ªèº«ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€StatefulBuilder ã‚’ä½¿ç”¨
    showDialog(
      context: context, // è¿™ä¸ª context æ˜¯ ReportDetailScreen çš„ context
      barrierDismissible: provider.feedbackStatus != FeedbackStatus.loading,
      builder: (BuildContext dialogContext) { // è¿™ä¸ª dialogContext æ˜¯ Dialog è‡ªå·±çš„æ–° context
        // [FIX] åœ¨è¿™é‡Œä½¿ç”¨ ChangeNotifierProvider.valueï¼Œ
        // å°† ReportDetailScreen çš„ provider å®ä¾‹ "æ³¨å…¥" åˆ°å¼¹çª—çš„ context ä¸­
        return ChangeNotifierProvider.value(
          value: provider,
          child: StatefulBuilder(
            builder: (context, setDialogState) { // ç°åœ¨çš„è¿™ä¸ª 'context' å¯ä»¥æ­£ç¡®æ‰¾åˆ° Provider
              // Provider ã®çŠ¶æ…‹ã‚’ãƒªãƒƒã‚¹ãƒ³
              // [FIX] ç°åœ¨è¿™ä¸ª context.watch å¯ä»¥æ­£å¸¸å·¥ä½œäº†
              final status = context.watch<ReportDetailProvider>().feedbackStatus;

              if (status == FeedbackStatus.success) {
                return AlertDialog(
                  title: const Text('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æˆåŠŸ'),
                  content: const Text('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚'),
                  actions: [
                    TextButton(
                      child: const Text('ç¢ºèª'),
                      onPressed: () {
                        Navigator.of(dialogContext).pop();
                        // Provider ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                        // [FIX] è¿™é‡Œä½¿ç”¨ context.read ä¹Ÿæ²¡é—®é¢˜äº†
                        context.read<ReportDetailProvider>().resetFeedbackState();
                      },
                    ),
                  ],
                );
              }

              return AlertDialog(
                title: const Text('èª¤æ¤œçŸ¥ã‚’å ±å‘Š'),
                content: SingleChildScrollView(
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„:'),
                      DropdownButton<String>(
                        isExpanded: true,
                        // [FIX] ä½¿ç”¨ context.watch æ¥è·å–æœ€æ–°çš„ provider çŠ¶æ€
                        value: context.watch<ReportDetailProvider>().selectedReason,
                        onChanged: (newValue) {
                          // [FIX] ä½¿ç”¨ context.read æ¥è°ƒç”¨ provider çš„æ–¹æ³•
                          context.read<ReportDetailProvider>().updateSelectedReason(newValue);
                          // setDialogState ã¯ä¸è¦ (Provider ãŒæ›´æ–°ã‚’é€šçŸ¥ã™ã‚‹ãŸã‚)
                        },
                        items: provider.errorReasons // 'provider' å®ä¾‹ä»ç„¶å¯ä»¥é€šè¿‡é—­åŒ…è®¿é—®
                            .map<DropdownMenuItem<String>>((String value) {
                          return DropdownMenuItem<String>(
                            value: value,
                            child: Text(value, overflow: TextOverflow.ellipsis),
                          );
                        }).toList(),
                      ),
                      const SizedBox(height: 16),
                      TextField(
                        maxLines: 4,
                        maxLength: 200,
                        decoration: const InputDecoration(
                          labelText: 'è£œè¶³æƒ…å ± (ä»»æ„)',
                          border: OutlineInputBorder(),
                        ),
                        onChanged: (value) {
                          // [FIX] ä½¿ç”¨ context.read æ¥è°ƒç”¨ provider çš„æ–¹æ³•
                          context.read<ReportDetailProvider>().updateFeedbackNotes(value);
                        },
                      ),
                    ],
                  ),
                ),
                actions: [
                  TextButton(
                    child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
                    onPressed: status == FeedbackStatus.loading
                        ? null
                        : () => Navigator.of(dialogContext).pop(),
                  ),
                  ElevatedButton(
                    child: status == FeedbackStatus.loading
                        ? const SizedBox(
                            width: 20,
                            height: 20,
                            child: CircularProgressIndicator(strokeWidth: 2))
                        : const Text('é€ä¿¡'),
                    onPressed: status == FeedbackStatus.loading
                        ? null
                        : () {
                            // [FIX] å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¸¡ã™
                            // [FIX] ä½¿ç”¨ context.read æ¥è·å– provider
                            final provider = context.read<ReportDetailProvider>();
                            final imageId = provider.currentImageIdForFeedback;
                            
                            if (imageId != null) {
                              provider.submitFeedback(
                                eventId: eventId,
                                imageId: imageId,
                                reason: provider.selectedReason,
                                notes: provider.feedbackNotes,
                              );
                            }
                          },
                  ),
                ],
              );
            },
          ),
        );
      },
    );
  }

  // --- Detail Widgets ---

  Widget _buildDetailRow(BuildContext context, String title, String value,
      {bool isScore = false, int score = 0}) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 120,
            child: Text(
              title,
              style: Theme.of(context)
                  .textTheme
                  .bodyLarge
                  ?.copyWith(fontWeight: FontWeight.bold),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: isScore
                  ? TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: score < 50 ? Colors.red : Colors.orange,
                    )
                  : Theme.of(context).textTheme.bodyLarge,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDeductionList(BuildContext context, List<String> deductions) {
    if (deductions.isEmpty) {
      return _buildDetailRow(context, 'æ‰£åˆ†é¡¹ç›®', 'ãªã—');
    }

    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              SizedBox(
                width: 120,
                child: Text(
                  'æ‰£åˆ†é¡¹ç›®',
                  style: Theme.of(context)
                      .textTheme
                      .bodyLarge
                      ?.copyWith(fontWeight: FontWeight.bold),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Padding(
            padding: const EdgeInsets.only(left: 16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: deductions.map((item) {
                return Text(
                  'ãƒ» $item',
                  style: Theme.of(context)
                      .textTheme
                      .bodyLarge
                      ?.copyWith(color: Colors.red[700]),
                );
              }).toList(),
            ),
          ),
        ],
      ),
    );
  }
}


report_history_screen.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:intl/intl.dart';
import '../providers/report_provider.dart';
import '../models/report_case.dart';
import 'report_detail_screen.dart';
import '../providers/report_detail_provider.dart';
import '../services/api_service.dart'; // [FIX] å¯¼å…¥ ApiService

class ReportHistoryScreen extends StatefulWidget {
  const ReportHistoryScreen({super.key});

  @override
  State<ReportHistoryScreen> createState() => _ReportHistoryScreenState();
}

class _ReportHistoryScreenState extends State<ReportHistoryScreen> {
  @override
  void initState() {
    super.initState();
    // ç”»é¢ãŒåˆæœŸåŒ–ã•ã‚ŒãŸæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<ReportProvider>().fetchReports();
    });
  }

  Future<void> _selectDateRange(BuildContext context) async {
    final provider = context.read<ReportProvider>();
    final initialRange = provider.selectedDateRange ??
        DateTimeRange(
          start: DateTime.now().subtract(const Duration(days: 7)),
          end: DateTime.now(),
        );

    // [FIXED] å°† lastDate è®¾ç½®ä¸ºæ˜å¤©çš„å¼€å§‹ï¼Œä»¥å…è®¸é€‰æ‹©ä»Šå¤© (10/28) 00:00:00 åˆ° 23:59:59 çš„èŒƒå›´
    final tomorrow = DateTime.now().add(const Duration(days: 1));
    final newRange = await showDateRangePicker(
      context: context,
      firstDate: DateTime(2024), // A more reasonable start date
      // [FIXED] lastDate å¿…é¡»æ˜¯å¯é€‰èŒƒå›´çš„ç»“æŸç‚¹
      lastDate: DateTime(tomorrow.year, tomorrow.month, tomorrow.day), 
      initialDateRange: initialRange,
    );

    if (newRange != null) {
      provider.fetchReports(dateRange: newRange);
    }
  }

  @override
  Widget build(BuildContext context) {
    // [FIX] ä» context ä¸­è·å– ApiService å®ä¾‹ï¼Œä¾› ReportDetailProvider ä½¿ç”¨
    final apiService = Provider.of<ApiService>(context, listen: false);

    return Consumer<ReportProvider>(
      builder: (context, provider, child) {
        return Column(
          children: [
            _buildDateSelector(context, provider),
            Expanded(
              child: provider.isLoading
                  ? const Center(child: CircularProgressIndicator())
                  : provider.error != null
                      ? Center(child: Text('ã‚¨ãƒ©ãƒ¼: ${provider.error!}'))
                      : provider.reports.isEmpty
                          ? const Center(
                              child: Text('æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚',
                                  style: TextStyle(fontSize: 16)))
                          : _buildReportList(provider.reports, apiService), // [FIXED] ä¼ é€’ apiService
            ),
          ],
        );
      },
    );
  }

  Widget _buildDateSelector(
      BuildContext context, ReportProvider provider) {
    final dateFormat = DateFormat('yyyy/MM/dd');
    final range = provider.selectedDateRange ??
        DateTimeRange(
          start: DateTime.now().subtract(const Duration(days: 7)),
          end: DateTime.now(),
        );

    return Padding(
      padding: const EdgeInsets.all(12.0),
      child: InkWell(
        onTap: () => _selectDateRange(context),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(8),
            boxShadow: [
              BoxShadow(
                color: Colors.grey.withOpacity(0.2),
                spreadRadius: 1,
                blurRadius: 4,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(Icons.calendar_today,
                  color: Colors.blue, size: 20),
              const SizedBox(width: 12),
              Text(
                '${dateFormat.format(range.start)} - ${dateFormat.format(range.end)}',
                style:
                    const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
              ),
              const SizedBox(width: 8),
              const Icon(Icons.arrow_drop_down, color: Colors.grey),
            ],
          ),
        ),
      ),
    );
  }

  // [FIXED] æ¥æ”¶ ApiService å‚æ•°
  Widget _buildReportList(List<ReportCase> reports, ApiService apiService) {
    return ListView.builder(
      itemCount: reports.length,
      itemBuilder: (context, index) {
        final reportCase = reports[index];
        return Card(
          margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          child: InkWell(
            onTap: () {
              Navigator.of(context).push(
                MaterialPageRoute(
                  builder: (_) => ChangeNotifierProvider(
                    // [FIXED] å°†å·²è®¤è¯çš„ apiService ä¼ é€’ç»™ ReportDetailProvider
                    create: (_) => ReportDetailProvider(apiService), 
                    child: ReportDetailScreen(
                        caseId: reportCase.id.toString()),
                  ),
                ),
              );
            },
            child: Padding(
              padding: const EdgeInsets.all(12.0),
              child: Row(
                children: [
                  // Thumbnail
                  Container(
                    width: 80,
                    height: 80,
                    color: Colors.grey[300],
                    child: const Icon(Icons.image_not_supported,
                        color: Colors.grey),
                  ),
                  const SizedBox(width: 16),
                  // Details
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'ã‚¹ã‚³ã‚¢: ${reportCase.score}',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: reportCase.score < 50
                                ? Colors.red
                                : Colors.orange,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Chip(
                          label: Text(reportCase.equipmentType, // [FIXED] ä½¿ç”¨ equipmentType
                              style: const TextStyle(fontSize: 12)),
                          padding: const EdgeInsets.symmetric(horizontal: 4),
                          visualDensity: VisualDensity.compact,
                        ),
                        const SizedBox(height: 4),
                        Text(
                          DateFormat('yyyy-MM-dd HH:mm')
                              .format(reportCase.eventTime), // [FIXED] ä½¿ç”¨ eventTime
                          style:
                              const TextStyle(color: Colors.grey, fontSize: 12),
                        ),
                      ],
                    ),
                  ),
                  const Icon(Icons.arrow_forward_ios, color: Colors.grey),
                ],
              ),
            ),
          ),
        );
      },
    );
  }
}
api_service.dart:
import 'package:flutter/material.dart'; // For DateTimeRange
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:io'; // For Platform check AND SocketException
import 'dart:async'; // For TimeoutException
import 'dart:developer' as developer; // [NEW] å¯¼å…¥ developer

class ApiService {
  // !!! é‡è¦: è¯·å†æ¬¡ç¡®è®¤æ­¤ URL å®Œå…¨æ­£ç¡® !!!
  static const String _renderUrl = 'https://playground-api-32jz.onrender.com/api'; // [USER PROVIDED URL - Please double check!]

  // æœ¬åœ°æµ‹è¯•æ—¶ä½¿ç”¨ (Android æ¨¡æ‹Ÿå™¨)
  static const String _localUrl = 'http://10.0.2.2:5000/api';

  // [DEBUG] ç¡®ä¿ä½¿ç”¨ Render URL
  static const String baseUrl = _renderUrl;

  final String? _token;
  ApiService(this._token);

  Map<String, String> get _headers {
    final headers = {
      'Content-Type': 'application/json; charset=UTF-8',
    };
    if (_token != null) {
      headers['Authorization'] = 'Bearer $_token';
    }
    return headers;
  }

  dynamic _handleResponse(http.Response response) {
     // ... (ä¹‹å‰çš„ _handleResponse ä»£ç ä¿æŒä¸å˜) ...
    // ä¿®å¤UTF-8ç¼–ç é—®é¢˜
    final body = utf8.decode(response.bodyBytes);
    developer.log('API Response Status: ${response.statusCode}, Body: $body', name: 'ApiService._handleResponse');
    final jsonResponse = jsonDecode(body);

    if (response.statusCode >= 200 && response.statusCode < 300) {
      if (jsonResponse is Map && jsonResponse.containsKey('success') && jsonResponse['success'] == true) {
        return jsonResponse.containsKey('data')
            ? jsonResponse['data']
            : jsonResponse as Map<String, dynamic>;
      } else if (jsonResponse is Map && jsonResponse.containsKey('success') && jsonResponse['success'] == false) {
         developer.log('API reported error: ${jsonResponse['message']}', name: 'ApiService._handleResponse', error: jsonResponse['message']);
        throw Exception(jsonResponse['message'] ?? 'API reported an error');
      } else {
        return jsonResponse;
      }
    } else {
       developer.log('HTTP error: ${response.statusCode}, Message: ${jsonResponse is Map ? jsonResponse['message'] : body}', name: 'ApiService._handleResponse', error: jsonResponse is Map ? jsonResponse['message'] : body);
      throw Exception((jsonResponse is Map ? jsonResponse['message'] : body) ?? 'Failed with status code ${response.statusCode}');
    }
  }


  Future<Map<String, dynamic>> login(String username, String password) async {
     // ... (login code remains the same) ...
     developer.log('Sending login request to $baseUrl/auth/login for user: $username', name: 'ApiService.login');
    try {
      developer.log('Inside try block, before http.post', name: 'ApiService.login');
      final response = await http.post(
        Uri.parse('$baseUrl/auth/login'),
        headers: {'Content-Type': 'application/json; charset=UTF-8'},
        body: jsonEncode({
          'username': username,
          'password': password,
        }),
      ).timeout(const Duration(seconds: 15));

      final body = utf8.decode(response.bodyBytes);
      developer.log('Login Response Status: ${response.statusCode}, Body: $body', name: 'ApiService.login');
      final jsonResponse = jsonDecode(body);

      if (response.statusCode == 200 && jsonResponse is Map && jsonResponse['success'] == true) {
        return jsonResponse as Map<String, dynamic>;
      } else {
         final message = (jsonResponse is Map ? jsonResponse['message'] : 'æœªçŸ¥é”™è¯¯') ?? 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
         developer.log('Login failed in ApiService', name: 'ApiService.login', error: message);
        throw Exception(message);
      }
    } on SocketException catch (e, stackTrace) {
      developer.log('Network Error (SocketException) during login', name: 'ApiService.login', error: e, stackTrace: stackTrace);
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${e.message}');
    } on TimeoutException catch (e, stackTrace) {
      developer.log('Network Error (TimeoutException) during login', name: 'ApiService.login', error: e, stackTrace: stackTrace);
      throw Exception('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
    } catch (e, stackTrace) {
       developer.log('Error during login HTTP call or processing', name: 'ApiService.login', error: e, stackTrace: stackTrace);
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}');
    }
  }

  Future<Map<String, dynamic>> register({
    required String username,
    required String password,
    required String email,
    required String fullName,
  }) async {
    final url = '$baseUrl/auth/register';
    final body = jsonEncode({
      'username': username,
      'password': password,
      'email': email,
      'full_name': fullName,
    });
    developer.log('Sending register request to $url with body: $body', name: 'ApiService.register');

    try {
      developer.log('Inside try block, before http.post', name: 'ApiService.register');
      final response = await http.post(
        Uri.parse(url),
        headers: {'Content-Type': 'application/json; charset=UTF-8'},
        body: body,
      ).timeout(const Duration(seconds: 15)); // ä¿æŒå¢åŠ çš„è¶…æ—¶æ—¶é—´

      print('âœ… Register response received: ${response.statusCode}'); // Use print for immediate visibility
      final responseBody = utf8.decode(response.bodyBytes);
      print('ğŸ“„ Response body: $responseBody'); // Use print for immediate visibility
      final jsonResponse = jsonDecode(responseBody);

      // [FIXED] Check for 201 Created status code for successful registration
      if (response.statusCode == 201 && jsonResponse is Map && jsonResponse['success'] == true) {
        developer.log('Registration successful in ApiService. Returning response.', name: 'ApiService.register');
        return jsonResponse as Map<String, dynamic>; // ç›´æ¥è¿”å› Map<String, dynamic>
      } else {
        // Handle failure cases (e.g., 409 Conflict, other errors)
        final message = (jsonResponse is Map ? jsonResponse['message'] : 'æœªçŸ¥é”™è¯¯') ?? 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
        developer.log('Register failed in ApiService with status ${response.statusCode}', name: 'ApiService.register', error: message);
        print('âŒ Register failed: $message'); // Use print for immediate visibility
        throw Exception(message); // Throw exception to be caught by AuthProvider
      }
    } on TimeoutException catch (e, stackTrace) {
      developer.log('Timeout error during register', name: 'ApiService.register', error: e, stackTrace: stackTrace);
      print('âŒ TIMEOUT ERROR in register: $e'); // Use print for immediate visibility
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } on SocketException catch (e, stackTrace) {
      developer.log('Network error during register', name: 'ApiService.register', error: e, stackTrace: stackTrace);
      print('âŒ NETWORK ERROR in register: $e'); // Use print for immediate visibility
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}');
    } on FormatException catch (e, stackTrace) {
      developer.log('JSON parse error during register', name: 'ApiService.register', error: e, stackTrace: stackTrace);
       print('âŒ JSON PARSE ERROR in register: $e'); // Use print for immediate visibility
      throw Exception('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
    } catch (e, stackTrace) {
      developer.log('Unexpected error during register', name: 'ApiService.register', error: e, stackTrace: stackTrace);
      print('âŒ UNEXPECTED ERROR in register: $e'); // Use print for immediate visibility
      print('Stack trace: $stackTrace');
      throw Exception('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}');
    }
  }


 // ... (getCameras, getEvents, getEventDetail, submitFeedback, getPeriodicReport) ...
 // [NOTE] The catch blocks in other methods were also updated to provide better logging
 // --- 2. æ‘„åƒå¤´ (Cameras) ---
  Future<List<dynamic>> getCameras() async {
     developer.log('Fetching cameras from $baseUrl/cameras', name: 'ApiService.getCameras');
    try {
       developer.log('Inside try block, before http.get', name: 'ApiService.getCameras');
      final response = await http.get(
        Uri.parse('$baseUrl/cameras'),
        headers: _headers,
      ).timeout(const Duration(seconds: 15));
      return _handleResponse(response);
    } on SocketException catch (e, stackTrace) {
      developer.log('Network Error (SocketException) fetching cameras', name: 'ApiService.getCameras', error: e, stackTrace: stackTrace);
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${e.message}');
    } on TimeoutException catch (e, stackTrace) {
      developer.log('Network Error (TimeoutException) fetching cameras', name: 'ApiService.getCameras', error: e, stackTrace: stackTrace);
      throw Exception('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
    } catch (e, stackTrace) {
       developer.log('Error fetching cameras', name: 'ApiService.getCameras', error: e, stackTrace: stackTrace);
      throw Exception('ã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}');
    }
  }

  // --- 3. äº‹ä»¶ (Events) ---
  Future<Map<String, dynamic>> getEvents({DateTimeRange? dateRange, int page = 1, int limit = 20}) async {
    // ... (queryParams å’Œ uri æ„å»º) ...
     final queryParams = {
      'page': page.toString(),
      'limit': limit.toString(),
      if (dateRange != null) ...{
        'start_date': dateRange.start.toIso8601String().split('T').first,
        'end_date': dateRange.end.toIso8601String().split('T').first,
      }
    };
    final uri = Uri.parse('$baseUrl/events').replace(queryParameters: queryParams);
     developer.log('Fetching events from $uri', name: 'ApiService.getEvents');

    try {
       developer.log('Inside try block, before http.get', name: 'ApiService.getEvents');
      final response = await http.get(uri, headers: _headers).timeout(const Duration(seconds: 20));

      // ... (response å¤„ç†) ...
      final body = utf8.decode(response.bodyBytes);
       developer.log('GetEvents Response Status: ${response.statusCode}, Body: $body', name: 'ApiService.getEvents');
      final jsonResponse = jsonDecode(body);

      if (response.statusCode == 200 && jsonResponse is Map && jsonResponse['success'] == true) {
        return jsonResponse as Map<String, dynamic>;
      } else {
         final message = (jsonResponse is Map ? jsonResponse['message'] : 'æœªçŸ¥é”™è¯¯') ?? 'ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±è´¥ã—ã¾ã—ãŸ';
          developer.log('getEvents failed in ApiService', name: 'ApiService.getEvents', error: message);
        throw Exception(message);
      }
    } on SocketException catch (e, stackTrace) {
      developer.log('Network Error (SocketException) fetching events', name: 'ApiService.getEvents', error: e, stackTrace: stackTrace);
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${e.message}');
    } on TimeoutException catch (e, stackTrace) {
      developer.log('Network Error (TimeoutException) fetching events', name: 'ApiService.getEvents', error: e, stackTrace: stackTrace);
      throw Exception('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
    } catch (e, stackTrace) {
       developer.log('Error fetching events', name: 'ApiService.getEvents', error: e, stackTrace: stackTrace);
       throw Exception('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}');
    }
  }

Future<Map<String, dynamic>> getEventDetail(String eventId) async {
  print('ğŸ”µ Fetching event detail from $baseUrl/events/$eventId'); // æ·»åŠ æ—¥å¿—
  
  try {
    final response = await http.get(
      Uri.parse('$baseUrl/events/$eventId'),
      headers: _headers,
    ).timeout(
      const Duration(seconds: 10),
      onTimeout: () {
        print('â±ï¸ getEventDetail timeout for eventId: $eventId');
        throw TimeoutException('Event detail request timeout');
      },
    );

    print('âœ… getEventDetail response: ${response.statusCode}');
    print('ğŸ“„ Response body: ${utf8.decode(response.bodyBytes)}');

    // æ‰‹åŠ¨å¤„ç†å“åº”ï¼Œé¿å… _handleResponse å¯èƒ½è¿”å› null
    final body = utf8.decode(response.bodyBytes);
    final jsonResponse = jsonDecode(body);

    if (response.statusCode == 200 && jsonResponse is Map && jsonResponse['success'] == true) {
      // ç¡®ä¿è¿”å›çš„æ˜¯ data å­—æ®µï¼Œä¸”ä¸ä¸º null
      final data = jsonResponse['data'];
      if (data == null) {
        print('âŒ Response data is null');
        throw Exception('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
      }
      return data as Map<String, dynamic>;
    } else {
      final message = (jsonResponse is Map ? jsonResponse['message'] : 'æœªçŸ¥é”™è¯¯') ?? 'ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      print('âŒ getEventDetail failed: $message');
      throw Exception(message);
    }

  } on TimeoutException catch (e, stackTrace) {
    print('âŒ TIMEOUT ERROR in getEventDetail: $e');
    developer.log('Timeout error', name: 'ApiService.getEventDetail', error: e, stackTrace: stackTrace);
    throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  } on SocketException catch (e, stackTrace) {
    print('âŒ NETWORK ERROR in getEventDetail: $e');
    developer.log('Network error', name: 'ApiService.getEventDetail', error: e, stackTrace: stackTrace);
    throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}');
  } on FormatException catch (e, stackTrace) {
    print('âŒ JSON PARSE ERROR in getEventDetail: $e');
    developer.log('JSON parse error', name: 'ApiService.getEventDetail', error: e, stackTrace: stackTrace);
    throw Exception('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
  } catch (e, stackTrace) {
    print('âŒ UNEXPECTED ERROR in getEventDetail: $e');
    print('Stack trace: $stackTrace');
    developer.log('Unexpected error', name: 'ApiService.getEventDetail', error: e, stackTrace: stackTrace);
    throw Exception('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}');
  }
}

  // --- 4. åé¦ˆ (Feedback) ---
  Future<Map<String, dynamic>> submitFeedback({required String eventId, required int imageId, required String reason, required String notes}) async {
    // ... (url å’Œ body æ„å»º) ...
     final url = '$baseUrl/feedback';
     final body = jsonEncode({
        'event_id': int.tryParse(eventId) ?? 0,
        'image_id': imageId,
        'reason': reason,
        'notes': notes,
      });
     developer.log('Submitting feedback to $url with body: $body', name: 'ApiService.submitFeedback');

    try {
       developer.log('Inside try block, before http.post', name: 'ApiService.submitFeedback');
      final response = await http.post(Uri.parse(url), headers: _headers, body: body).timeout(const Duration(seconds: 20));
      return await _handleResponse(response) as Map<String, dynamic>;
     } on SocketException catch (e, stackTrace) {
      developer.log('Network Error (SocketException) submitting feedback', name: 'ApiService.submitFeedback', error: e, stackTrace: stackTrace);
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${e.message}');
    } on TimeoutException catch (e, stackTrace) {
      developer.log('Network Error (TimeoutException) submitting feedback', name: 'ApiService.submitFeedback', error: e, stackTrace: stackTrace);
      throw Exception('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
    } catch (e, stackTrace) {
       developer.log('Error submitting feedback', name: 'ApiService.submitFeedback', error: e, stackTrace: stackTrace);
       throw Exception('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}');
    }
  }

  // --- 5. å®šæœŸæŠ¥å‘Š (Reports) ---
  Future<Map<String, dynamic>> getPeriodicReport({String type = 'monthly'}) async {
    // ... (uri æ„å»º) ...
    final uri = Uri.parse('$baseUrl/reports').replace(queryParameters: {'type': type});
     developer.log('Fetching periodic report from $uri', name: 'ApiService.getPeriodicReport');

    try {
       developer.log('Inside try block, before http.get', name: 'ApiService.getPeriodicReport');
      final response = await http.get(uri, headers: _headers).timeout(const Duration(seconds: 20));

      // ... (response å¤„ç†) ...
       final body = utf8.decode(response.bodyBytes);
      developer.log('GetPeriodicReport Response Status: ${response.statusCode}, Body: $body', name: 'ApiService.getPeriodicReport');
      final jsonResponse = jsonDecode(body);

      if (response.statusCode == 200 && jsonResponse is Map && jsonResponse['success'] == true) {
        return jsonResponse as Map<String, dynamic>;
      } else {
         final message = (jsonResponse is Map ? jsonResponse['message'] : 'æœªçŸ¥é”™è¯¯') ?? 'ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ã«å¤±è´¥ã—ã¾ã—ãŸ';
         developer.log('getPeriodicReport failed in ApiService', name: 'ApiService.getPeriodicReport', error: message);
        throw Exception(message);
      }
     } on SocketException catch (e, stackTrace) {
      developer.log('Network Error (SocketException) fetching periodic report', name: 'ApiService.getPeriodicReport', error: e, stackTrace: stackTrace);
      throw Exception('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${e.message}');
    } on TimeoutException catch (e, stackTrace) {
      developer.log('Network Error (TimeoutException) fetching periodic report', name: 'ApiService.getPeriodicReport', error: e, stackTrace: stackTrace);
      throw Exception('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
    } catch (e, stackTrace) {
       developer.log('Error fetching periodic report', name: 'ApiService.getPeriodicReport', error: e, stackTrace: stackTrace);
       throw Exception('ãƒ¬ãƒãƒ¼ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.toString()}');
    }
  }

}

main.dart:
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'providers/auth_provider.dart';
import 'services/api_service.dart';
import 'screens/main_screen.dart';
import 'screens/login_screen.dart';
import 'providers/camera_provider.dart';
// [FIXME] This import is likely causing a conflict, 
// but we will fix the file 'report_provider.dart' in the next step.
import 'providers/report_provider.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    // MultiProvider setup with ProxyProviders to correctly handle dependencies
    return MultiProvider(
      providers: [
        // 1. AuthProvider (Independent)
        ChangeNotifierProvider(
          create: (context) => AuthProvider(),
        ),

        // 2. ApiService (Depends on AuthProvider's token)
        ProxyProvider<AuthProvider, ApiService>(
          update: (context, authProvider, previousApiService) {
            return ApiService(authProvider.token);
          },
        ),

        // 3. CameraProvider (Depends on ApiService)
        ChangeNotifierProxyProvider<ApiService, CameraProvider>(
          // [FIXED] Added the required 'create' parameter.
          // This creates the initial provider instance.
          create: (context) => CameraProvider(
            Provider.of<ApiService>(context, listen: false),
          ),
          // 'update' rebuilds the provider when ApiService changes (e.g., after login)
          update: (context, apiService, previousCameraProvider) {
            return CameraProvider(apiService);
          },
        ),

        // 4. ReportProvider (Depends on ApiService)
        ChangeNotifierProxyProvider<ApiService, ReportProvider>(
          // [FIXED] Added the required 'create' parameter.
          create: (context) => ReportProvider(
            Provider.of<ApiService>(context, listen: false),
          ),
          update: (context, apiService, previousReportProvider) {
            return ReportProvider(apiService);
          },
        ),
      ],
      child: Consumer<AuthProvider>(
        builder: (context, auth, _) {
          return MaterialApp(
            title: 'Safety Playground App',
            theme: ThemeData(
              // ... (rest of your theme data)
              primaryColor: const Color(0xFF0D6EFD),
              scaffoldBackgroundColor: const Color(0xFFF8F9FA),
              // ... (rest of your theme data)
            ),
            debugShowCheckedModeBanner: false,
            // Automatically show LoginScreen or MainScreen based on auth state
            home: auth.isAuthenticated ? const MainScreen() : const LoginScreen(),
            routes: {
              '/login': (context) => const LoginScreen(),
              '/main': (context) => const MainScreen(),
            },
          );
        },
      ),
    );
  }
}


